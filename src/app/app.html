@let settings = settings$ | async;
@let weather = weatherData$ | async;
@let search = searchResults$ | async;

@if (settings) {
  <div>
    @if (weather) {
      <div
        class="background-container"
        [style.background-image]="'url(' + getBackgroundImage(weather.list[0].weather[0].main) + ')'">
      </div>

      <div class="dashboard-wrapper">
        <header>
          <button class="settings-btn" (click)="isSettingsOpen = true">⚙️</button>
          <h1>Погодный дашборд</h1>

          <div class="search-container">
            <input
              class="search-box"
              placeholder="Найти город..."
              [(ngModel)]="searchQuery"
              (input)="onSearchInput()"
              (focus)="onSearchFocus()"
              (blur)="onSearchBlur()"
              autocomplete="off">

            <!-- Выпадающий список с результатами -->
            @if (search || searchHint) {
              <div class="search-results">
                @if (isSearchListVisible) {
                  <ul>
                    @if (searchHint) {
                      <li class="search-hint">{{ searchHint }}</li>
                    }
                    @if (search && search.length > 0) {
                      @for (city of search; track city) {
                        <li (click)="selectCity(city)">
                          {{ getDisplayName(city) }}
                        </li>
                      }
                    }

                  </ul>
                }
              </div>
            }

          </div>
        </header>

        @if (weather.list && weather.list.length > 0) {
          <main>
            <section class="current-weather-card">

              <h2>{{ weather.city.name }}, {{ weather.city.country }}</h2>
              <div class="main-info">
                <img [src]="'https://openweathermap.org/img/wn/' + weather.list[0].weather[0].icon + '@2x.png'"
                     [alt]="weather.list[0].weather[0].description">
                <div class="temperature-details">
                <span class="temperature"
                      [style.color]="getTempColor(weather.list[0].main.temp)">{{ weather.list[0].main.temp | temperature:settings.tempUnit | number:'1.0-0' }}
                  °{{ settings.tempUnit }}</span>
                  <span
                    class="feels-like">Ощущается как {{ weather.list[0].main.feels_like | temperature:settings.tempUnit | number:'1.0-0' }}
                    °{{ settings.tempUnit }}</span>
                </div>
              </div>

              <p class="condition-text">{{ weather.list[0].weather[0].description }}</p>

              <div class="details">
                <div class="humidity-details element-details">
                  Влажность: {{ weather.list[0].main.humidity }}%
                </div>
                <div class="wind-details element-details">
                  Ветер:
                  {{ weather.list[0].wind.speed | wind:settings.windUnit | number:'1.0-1' }} {{ settings.windUnit === 'ms' ? 'м/с' : settings.windUnit === 'kmh' ? 'км/ч' : 'миль/ч' }}
                  <div class="wind-direction" [style.transform]="'rotate(' + weather.list[0].wind.deg + 'deg)'">↑</div>
                </div>
                <div class="pressure-details element-details">
              <span>
                Давление:
                {{ weather.list[0].main.pressure | pressure:settings.pressureUnit | number:'1.0-0' }}
                {{ settings.pressureUnit === 'hPa' ? 'гПа' : 'мм рт.ст.' }}
              </span>
                  <span class="pressure-hint" [ngClass]="getPressureHint(weather.list[0].main.pressure).className">
                  {{ getPressureHint(weather.list[0].main.pressure).text }}
              </span>
                </div>
              </div>

              <div class="chart-container">
                <canvas #forecastChart></canvas>
              </div>
            </section>
          </main>
        }

      </div>
    } @else {
      <div class="loading">
        Fetching Weather Data
      </div>
      <ng-container *ngTemplateOutlet="loading"></ng-container>
    }

    <ng-template #loading>
      <div class="loader">
        Загрузка данных о погоде...
      </div>
    </ng-template>

    <app-settings-drawer
      [isOpen]="isSettingsOpen"
      [settings]="settings"
      (closeDrawer)="isSettingsOpen = false"
      (settingsChange)="onSettingsChange($event)">
    </app-settings-drawer>

  </div>
} @else {
  <div class="loading">
    Settings Loading
  </div>
}

<router-outlet></router-outlet>
